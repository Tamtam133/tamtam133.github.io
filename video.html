<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Puzzle English Clone</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Стили для паззлов поверх видео */
    .player-container { position: relative; width: 640px; margin: 0 auto; }
    #puzzle-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.85); display: none; flex-direction: column;
      align-items: center; justify-content: center; z-index: 10; color: white; padding: 20px; box-sizing: border-box;
    }
    .words-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 20px; }
    .word-btn { 
      padding: 8px 15px; background: #444; border: 1px solid #666; color: white; 
      cursor: pointer; border-radius: 4px; font-size: 1.1em;
    }
    .word-btn:hover { background: #666; }
    .result-area { 
      min-height: 50px; border-bottom: 2px solid #555; width: 100%; 
      margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;
    }
    .word-btn.used { opacity: 0.3; pointer-events: none; }
    .correct { color: #4caf50; font-weight: bold; margin-top: 10px; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1 class="site-title">Видео-паззл</h1>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="controls stack">
        <div class="row">
            <label class="field">
                <span class="label">ID или URL видео</span>
                <input id="vid" type="text" placeholder="dQw4w9WgXcQ" />
            </label>
            <button id="load">Загрузить видео</button>
        </div>

        <div class="row">
            <label class="field">
                <span class="label">Файл субтитров (.srt)</span>
                <input id="srtFile" type="file" accept=".srt" />
            </label>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="player-container">
        <div id="player" class="player-wrap"></div>
        <div id="puzzle-overlay">
            <div id="result-area" class="result-area"></div>
            <div id="words-pool" class="words-container"></div>
            <button id="check-btn" style="display:none">Проверить</button>
            <div id="feedback"></div>
        </div>
      </div>
      <p class="muted small">Загрузите видео и SRT файл. Видео остановится в конце каждой фразы.</p>
    </section>
  </main>

  <script>
  const $ = (id) => document.getElementById(id);

  let ytPlayer = null;
  let playerReady = false;

  let subtitles = [];
  let currentSubIndex = -1;
  let userSentence = [];

  let tickTimer = null;

  function parseSRT(data) {
    data = data.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const regex = /(\d+)\n(\d{2}:\d{2}:\d{2}[,.]\d{3}) --> (\d{2}:\d{2}:\d{2}[,.]\d{3})\n([\s\S]*?)(?=\n{2}|\n$|$)/g;
    let m;
    const result = [];
    while ((m = regex.exec(data)) !== null) {
      result.push({
        start: timeToSeconds(m[2]),
        end: timeToSeconds(m[3]),
        text: m[4]
          .replace(/<[^>]*>/g, '')
          .replace(/\n/g, ' ')
          .replace(/[.,!?;:"-]/g, '')
          .trim(),
        solved: false
      });
    }
    if (result.length === 0) alert("Не найдено фраз. Проверьте формат SRT.");
    else alert(`Загружено фраз: ${result.length}`);
    return result;
  }

  function timeToSeconds(timeStr) {
    timeStr = timeStr.replace('.', ',');
    const [h, m, s] = timeStr.split(':');
    const [sec, ms] = s.split(',');
    return parseInt(h) * 3600 + parseInt(m) * 60 + parseInt(sec) + parseInt(ms) / 1000;
  }

  function initPuzzle(text) {
    const words = text.split(' ').sort(() => Math.random() - 0.5);
    userSentence = [];
    $("words-pool").innerHTML = '';
    $("result-area").innerHTML = '';
    $("puzzle-overlay").style.display = 'flex';
    $("feedback").textContent = '';

    if (ytPlayer && typeof ytPlayer.pauseVideo === 'function') {
      ytPlayer.pauseVideo();
    }

    words.forEach((word) => {
      const btn = document.createElement('button');
      btn.className = 'word-btn';
      btn.textContent = word;
      btn.onclick = () => {
        if (btn.classList.contains('used')) return;
        btn.classList.add('used');
        userSentence.push(word);
        renderUserSentence(text);
      };
      $("words-pool").appendChild(btn);
    });
  }

  function renderUserSentence(originalText) {
    $("result-area").innerHTML = '';
    userSentence.forEach(word => {
      const span = document.createElement('span');
      span.className = 'word-btn';
      span.textContent = word;
      $("result-area").appendChild(span);
    });

    if (userSentence.join(' ') === originalText) {
      $("feedback").innerHTML = '<span class="correct">Правильно!</span>';
      setTimeout(() => {
        $("puzzle-overlay").style.display = 'none';
        subtitles[currentSubIndex].solved = true;
        ytPlayer?.playVideo?.();
      }, 700);
    }
  }

  function tick() {
    if (!ytPlayer?.getCurrentTime) return;
    if (!subtitles.length) return;

    const t = ytPlayer.getCurrentTime();

    // ищем активную фразу
    const subIdx = subtitles.findIndex(s => t >= s.start && t <= s.end);
    if (subIdx !== -1) currentSubIndex = subIdx;

    // если мы уже в какой-то фразе и дошли до конца — показываем паззл
    if (currentSubIndex !== -1) {
      const s = subtitles[currentSubIndex];
      if (t >= s.end && !s.solved && $("puzzle-overlay").style.display !== 'flex') {
        initPuzzle(s.text);
      }
    }
  }

  function onStateChange(e) {
    if (e.data === YT.PlayerState.PLAYING) {
      if (tickTimer) return;               // не плодим интервалы
      tickTimer = setInterval(tick, 200);
    } else {
      if (tickTimer) {
        clearInterval(tickTimer);
        tickTimer = null;
      }
    }
  }

  window.onYouTubeIframeAPIReady = function () {
    ytPlayer = new YT.Player("player", {
      height: "360",
      width: "640",
      playerVars: {
        playsinline: 1,
        origin: location.origin
      },
      events: {
        onReady: () => {
          playerReady = true;
          console.log("YouTube player is ready");
        },
        onStateChange: onStateChange
      }
    });
  };

  $("load").onclick = () => {
    const id = extractId($("vid").value);

    if (!playerReady) {
      alert("Плеер YouTube еще не готов. Открой консоль — должно быть 'YouTube player is ready'.");
      return;
    }
    if (id) ytPlayer.loadVideoById(id);
  };

  $("srtFile").onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      subtitles = parseSRT(event.target.result);
      currentSubIndex = -1;
    };
    reader.readAsText(file);
  };

  function extractId(url) {
    if (!url) return null;
    const m = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|shorts\/)|youtu\.be\/)([\w-]{11})/);
    return m ? m[1] : url.trim();
  }

  // Подключение API
  const tag = document.createElement("script");
  tag.src = "https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);
</script>
</body>
</html>

